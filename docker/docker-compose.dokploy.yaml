version: "3.8"

# Shared environment variables for API and Worker services
x-shared-env: &shared-api-worker-env # Database Configuration
  DB_USERNAME: ${DB_USERNAME:-postgres}
  DB_PASSWORD: ${DB_PASSWORD:-difyai123456}
  DB_HOST: ${DB_HOST:-db}
  DB_PORT: ${DB_PORT:-5432}
  DB_DATABASE: ${DB_DATABASE:-dify}

  # Redis Configuration
  REDIS_HOST: ${REDIS_HOST:-redis}
  REDIS_PORT: ${REDIS_PORT:-6379}
  REDIS_DB: ${REDIS_DB:-0}
  REDIS_PASSWORD: ${REDIS_PASSWORD:-difyai123456}
  CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://:${REDIS_PASSWORD:-difyai123456}@redis:6379/1}
  BROKER_USE_SSL: ${BROKER_USE_SSL:-false}

  # Vector Store - Weaviate Configuration
  VECTOR_STORE: ${VECTOR_STORE:-weaviate}
  WEAVIATE_ENDPOINT: ${WEAVIATE_ENDPOINT:-http://weaviate:8080}
  WEAVIATE_API_KEY: ${WEAVIATE_API_KEY:-WVF5YThaHlkYwhGUSmCRgsX3tD5ngdN8pkih}

  # Storage Configuration (local)
  STORAGE_TYPE: ${STORAGE_TYPE:-local}
  STORAGE_LOCAL_PATH: ${STORAGE_LOCAL_PATH:-storage}

  # Core Configuration
  MODE: ${MODE:-}
  LOG_LEVEL: ${LOG_LEVEL:-INFO}
  SECRET_KEY: ${SECRET_KEY:-sk-9f73s3ljTXVcMT3Blb3ljTqtsKiGHXVcMT3BlbkFJLK7U}
  CONSOLE_WEB_URL: ${CONSOLE_WEB_URL:-}
  CONSOLE_API_URL: ${CONSOLE_API_URL:-}
  SERVICE_API_URL: ${SERVICE_API_URL:-}
  APP_WEB_URL: ${APP_WEB_URL:-}
  APP_API_URL: ${APP_API_URL:-}
  FILES_URL: ${FILES_URL:-}
  MIGRATION_ENABLED: ${MIGRATION_ENABLED:-true}

  # SSRF Protection
  SSRF_PROXY_HTTP_URL: ${SSRF_PROXY_HTTP_URL:-http://ssrf_proxy:3128}
  SSRF_PROXY_HTTPS_URL: ${SSRF_PROXY_HTTPS_URL:-http://ssrf_proxy:3128}

  # Sandbox Configuration
  CODE_EXECUTION_ENDPOINT: ${CODE_EXECUTION_ENDPOINT:-http://sandbox:8194}
  CODE_EXECUTION_API_KEY: ${SANDBOX_API_KEY:-dify-sandbox}
  CODE_MAX_NUMBER: ${CODE_MAX_NUMBER:-9223372036854775807}
  CODE_MIN_NUMBER: ${CODE_MIN_NUMBER:--9223372036854775808}
  CODE_MAX_STRING_LENGTH: ${CODE_MAX_STRING_LENGTH:-80000}
  TEMPLATE_TRANSFORM_MAX_LENGTH: ${TEMPLATE_TRANSFORM_MAX_LENGTH:-80000}
  CODE_MAX_STRING_ARRAY_LENGTH: ${CODE_MAX_STRING_ARRAY_LENGTH:-30}
  CODE_MAX_OBJECT_ARRAY_LENGTH: ${CODE_MAX_OBJECT_ARRAY_LENGTH:-30}
  CODE_MAX_NUMBER_ARRAY_LENGTH: ${CODE_MAX_NUMBER_ARRAY_LENGTH:-1000}

  # Plugin Daemon Configuration
  PLUGIN_DAEMON_URL: ${PLUGIN_DAEMON_URL:-http://plugin_daemon:5002}
  PLUGIN_DAEMON_KEY: ${PLUGIN_DAEMON_KEY:-lYkiYYT6owG+71oLerGzA7GXCgOT++6ovaezWAjpCjf+Sjc3ZtU+qUEi}
  PLUGIN_REMOTE_INSTALL_HOST: ${PLUGIN_REMOTE_INSTALL_HOST:-plugin_daemon}
  PLUGIN_REMOTE_INSTALL_PORT: ${PLUGIN_REMOTE_INSTALL_PORT:-5003}
  INNER_API_KEY_FOR_PLUGIN: ${PLUGIN_DIFY_INNER_API_KEY:-QaHbTe77CtuXmsfyhR7+vRjI/+XbV1AaFy691iy+kGDv2Jvy0/eAh8Y1}

services:
  # Init container to fix storage permissions
  init_permissions:
    image: busybox:latest
    command:
      - sh
      - -c
      - |
        echo "Initializing permissions for /app/api/storage"
        chown -R 1001:1001 /app/api/storage
        echo "Permissions initialized successfully"
    volumes:
      - app_storage:/app/api/storage
    restart: "no"

  # PostgreSQL Database
  db:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_USER: ${DB_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-difyai123456}
      POSTGRES_DB: ${DB_DATABASE:-dify}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - db_data:/var/lib/postgresql/data
    healthcheck:
      test:
        [
          "CMD",
          "pg_isready",
          "-U",
          "${DB_USERNAME:-postgres}",
          "-d",
          "${DB_DATABASE:-dify}",
        ]
      interval: 5s
      timeout: 3s
      retries: 30

  # Redis Cache
  redis:
    image: redis:6-alpine
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD:-difyai123456}
    volumes:
      - redis_data:/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "redis-cli -a ${REDIS_PASSWORD:-difyai123456} ping | grep -q PONG",
        ]
      interval: 5s
      timeout: 3s
      retries: 30

  # Weaviate Vector Store
  weaviate:
    image: semitechnologies/weaviate:1.27.0
    restart: always
    volumes:
      - weaviate_data:/var/lib/weaviate
    environment:
      PERSISTENCE_DATA_PATH: /var/lib/weaviate
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: false
      DEFAULT_VECTORIZER_MODULE: none
      CLUSTER_HOSTNAME: node1
      AUTHENTICATION_APIKEY_ENABLED: true
      AUTHENTICATION_APIKEY_ALLOWED_KEYS: ${WEAVIATE_API_KEY:-WVF5YThaHlkYwhGUSmCRgsX3tD5ngdN8pkih}
      AUTHENTICATION_APIKEY_USERS: hello@dify.ai
      AUTHORIZATION_ADMINLIST_ENABLED: true
      AUTHORIZATION_ADMINLIST_USERS: hello@dify.ai
      DISABLE_TELEMETRY: true
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--spider",
          "-q",
          "http://localhost:8080/v1/.well-known/ready",
        ]
      interval: 10s
      timeout: 3s
      retries: 30

  # Sandbox for code execution
  sandbox:
    image: langgenius/dify-sandbox:0.2.12
    restart: always
    environment:
      API_KEY: ${SANDBOX_API_KEY:-dify-sandbox}
      GIN_MODE: release
      WORKER_TIMEOUT: 15
      ENABLE_NETWORK: true
      HTTP_PROXY: http://ssrf_proxy:3128
      HTTPS_PROXY: http://ssrf_proxy:3128
      SANDBOX_PORT: 8194
    volumes:
      - sandbox_dependencies:/dependencies
      - sandbox_conf:/conf
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8194/health"]
      interval: 10s
      timeout: 3s
      retries: 30
    networks:
      - default
      - ssrf_proxy_network

  # SSRF Proxy (Simplified for Dokploy)
  ssrf_proxy:
    image: ubuntu/squid:latest
    restart: always
    entrypoint: ["/bin/sh"]
    command:
      - "-c"
      - |
        cat > /etc/squid/squid.conf << 'EOF'
        http_port 3128
        coredump_dir /var/spool/squid

        acl localnet src 10.0.0.0/8
        acl localnet src 172.16.0.0/12
        acl localnet src 192.168.0.0/16
        acl SSL_ports port 443
        acl Safe_ports port 80
        acl Safe_ports port 443
        acl Safe_ports port 1025-65535
        acl CONNECT method CONNECT

        http_access deny !Safe_ports
        http_access deny CONNECT !SSL_ports
        http_access allow localhost
        http_access allow localnet
        http_access deny all

        http_port 8194 accel defaultsite=sandbox vhost
        cache_peer sandbox parent 8194 0 no-query originserver name=sandbox
        acl sandbox_domain dstdomain sandbox
        http_access allow sandbox_domain
        cache_peer_access sandbox allow sandbox_domain
        EOF

        squid -N -f /etc/squid/squid.conf
    networks:
      - default
      - ssrf_proxy_network

  # Plugin Daemon
  plugin_daemon:
    image: langgenius/dify-plugin-daemon:0.5.2-local
    restart: always
    environment:
      <<: *shared-api-worker-env
      DB_DATABASE: ${DB_PLUGIN_DATABASE:-dify_plugin}
      SERVER_PORT: 5002
      SERVER_KEY: ${PLUGIN_DAEMON_KEY:-lYkiYYT6owG+71oLerGzA7GXCgOT++6ovaezWAjpCjf+Sjc3ZtU+qUEi}
      DIFY_INNER_API_URL: http://api:5001
      DIFY_INNER_API_KEY: ${PLUGIN_DIFY_INNER_API_KEY:-QaHbTe77CtuXmsfyhR7+vRjI/+XbV1AaFy691iy+kGDv2Jvy0/eAh8Y1}
      PLUGIN_REMOTE_INSTALLING_HOST: 0.0.0.0
      PLUGIN_REMOTE_INSTALLING_PORT: 5003
      PLUGIN_WORKING_PATH: /app/storage/cwd
      PLUGIN_STORAGE_TYPE: local
      PLUGIN_STORAGE_LOCAL_ROOT: /app/storage
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - plugin_daemon_data:/app/storage

  # API Service
  api:
    image: langgenius/dify-api:1.11.2
    restart: always
    environment:
      <<: *shared-api-worker-env
      MODE: api
    depends_on:
      init_permissions:
        condition: service_completed_successfully
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      weaviate:
        condition: service_healthy
      sandbox:
        condition: service_healthy
      plugin_daemon:
        condition: service_started
    volumes:
      - app_storage:/app/api/storage
    networks:
      - default
      - ssrf_proxy_network

  # Worker Service
  worker:
    image: langgenius/dify-api:1.11.2
    restart: always
    environment:
      <<: *shared-api-worker-env
      MODE: worker
    depends_on:
      init_permissions:
        condition: service_completed_successfully
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - app_storage:/app/api/storage
    networks:
      - default
      - ssrf_proxy_network

  # Worker Beat (Scheduler)
  worker_beat:
    image: langgenius/dify-api:1.11.2
    restart: always
    environment:
      <<: *shared-api-worker-env
      MODE: beat
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - default
      - ssrf_proxy_network

  # Web Frontend
  web:
    image: langgenius/dify-web:1.11.2
    restart: always
    environment:
      CONSOLE_API_URL: ${CONSOLE_API_URL:-}
      APP_API_URL: ${APP_API_URL:-}
      NEXT_TELEMETRY_DISABLED: 1
    depends_on:
      - api

  # Nginx - Single entry point for Traefik/Dokploy
  nginx:
    image: nginx:latest
    restart: always
    ports:
      - "80"
    depends_on:
      - api
      - web
    entrypoint: ["/bin/sh"]
    command:
      - "-c"
      - |
        cat > /etc/nginx/conf.d/default.conf << 'EOF'
        server {
            listen 80;
            server_name _;
            client_max_body_size 100M;

            location /console/api {
                proxy_pass http://api:5001;
                proxy_set_header Host $$host;
                proxy_set_header X-Real-IP $$remote_addr;
                proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $$scheme;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_buffering off;
                proxy_read_timeout 3600s;
                proxy_send_timeout 3600s;
            }

            location /api {
                proxy_pass http://api:5001;
                proxy_set_header Host $$host;
                proxy_set_header X-Real-IP $$remote_addr;
                proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $$scheme;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_buffering off;
                proxy_read_timeout 3600s;
                proxy_send_timeout 3600s;
            }

            location /v1 {
                proxy_pass http://api:5001;
                proxy_set_header Host $$host;
                proxy_set_header X-Real-IP $$remote_addr;
                proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $$scheme;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_buffering off;
                proxy_read_timeout 3600s;
                proxy_send_timeout 3600s;
            }

            location /files {
                proxy_pass http://api:5001;
                proxy_set_header Host $$host;
                proxy_set_header X-Real-IP $$remote_addr;
                proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $$scheme;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_buffering off;
                proxy_read_timeout 3600s;
                proxy_send_timeout 3600s;
            }

            location /mcp {
                proxy_pass http://api:5001;
                proxy_set_header Host $$host;
                proxy_set_header X-Real-IP $$remote_addr;
                proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $$scheme;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_buffering off;
                proxy_read_timeout 3600s;
                proxy_send_timeout 3600s;
            }

            location /triggers {
                proxy_pass http://api:5001;
                proxy_set_header Host $$host;
                proxy_set_header X-Real-IP $$remote_addr;
                proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $$scheme;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_buffering off;
                proxy_read_timeout 3600s;
                proxy_send_timeout 3600s;
            }

            location /explore {
                proxy_pass http://web:3000;
                proxy_set_header Host $$host;
                proxy_set_header X-Real-IP $$remote_addr;
                proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $$scheme;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_buffering off;
                proxy_read_timeout 3600s;
                proxy_send_timeout 3600s;
            }

            location / {
                proxy_pass http://web:3000;
                proxy_set_header Host $$host;
                proxy_set_header X-Real-IP $$remote_addr;
                proxy_set_header X-Forwarded-For $$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $$scheme;
                proxy_http_version 1.1;
                proxy_set_header Connection "";
                proxy_buffering off;
                proxy_read_timeout 3600s;
                proxy_send_timeout 3600s;
            }
        }
        EOF

        nginx -g 'daemon off;'

volumes:
  db_data:
  redis_data:
  weaviate_data:
  app_storage:
  sandbox_dependencies:
  sandbox_conf:
  plugin_daemon_data:

networks:
  default:
    driver: bridge
  ssrf_proxy_network:
    driver: bridge
    internal: true
